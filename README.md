<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>test</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="eintrag-4">Eintrag 4</h1>
<p><strong>Aufgabe:</strong><br>
Feature Tracking mit OpenCV. Zwei Bilder auf Ähnlichkeiten vergleichen, um Orte im Haus wiederzuerkennen und zuordnen zu können</p>
<p><strong>Lösung:</strong></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
MIN_MATCH_COUNT <span class="token operator">=</span> <span class="token number">10</span>
img1 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'Webcam1.png'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>          <span class="token comment"># queryImage</span>
img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'Webcam2.png'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># trainImage</span>
<span class="token comment"># Initiate SIFT detector</span>
sift <span class="token operator">=</span> cv2<span class="token punctuation">.</span>xfeatures2d<span class="token punctuation">.</span>SIFT_create<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># find the keypoints and descriptors with SIFT</span>
kp1<span class="token punctuation">,</span> des1 <span class="token operator">=</span> sift<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>img1<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span>
kp2<span class="token punctuation">,</span> des2 <span class="token operator">=</span> sift<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>img2<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span>
FLANN_INDEX_KDTREE <span class="token operator">=</span> <span class="token number">1</span>
index_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>algorithm <span class="token operator">=</span> FLANN_INDEX_KDTREE<span class="token punctuation">,</span> trees <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
search_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>checks <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span>
flann <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FlannBasedMatcher<span class="token punctuation">(</span>index_params<span class="token punctuation">,</span> search_params<span class="token punctuation">)</span>
matches <span class="token operator">=</span> flann<span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>des1<span class="token punctuation">,</span>des2<span class="token punctuation">,</span>k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># store all the good matches as per Lowe's ratio test.</span>
good <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> m<span class="token punctuation">,</span>n <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
    <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.7</span><span class="token operator">*</span>n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
        good<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>good<span class="token punctuation">)</span><span class="token operator">&gt;</span>MIN_MATCH_COUNT<span class="token punctuation">:</span>
    src_pts <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span> kp1<span class="token punctuation">[</span>m<span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt <span class="token keyword">for</span> m <span class="token keyword">in</span> good <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    dst_pts <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span> kp2<span class="token punctuation">[</span>m<span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt <span class="token keyword">for</span> m <span class="token keyword">in</span> good <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    M<span class="token punctuation">,</span> mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findHomography<span class="token punctuation">(</span>src_pts<span class="token punctuation">,</span> dst_pts<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>RANSAC<span class="token punctuation">,</span><span class="token number">5.0</span><span class="token punctuation">)</span>
    matchesMask <span class="token operator">=</span> mask<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    h<span class="token punctuation">,</span>w <span class="token operator">=</span> img1<span class="token punctuation">.</span>shape
    pts <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span>h<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>w<span class="token number">-1</span><span class="token punctuation">,</span>h<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>w<span class="token number">-1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
    dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>perspectiveTransform<span class="token punctuation">(</span>pts<span class="token punctuation">,</span>M<span class="token punctuation">)</span>
    img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>img2<span class="token punctuation">,</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span> <span class="token string">"Not enough matches are found - {}/{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>good<span class="token punctuation">)</span><span class="token punctuation">,</span> MIN_MATCH_COUNT<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    matchesMask <span class="token operator">=</span> <span class="token boolean">None</span>
draw_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>matchColor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># draw matches in green color</span>
                   singlePointColor <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                   matchesMask <span class="token operator">=</span> matchesMask<span class="token punctuation">,</span> <span class="token comment"># draw only inliers</span>
                   flags <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
img3 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>drawMatches<span class="token punctuation">(</span>img1<span class="token punctuation">,</span>kp1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>kp2<span class="token punctuation">,</span>good<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token operator">**</span>draw_params<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img3<span class="token punctuation">,</span> <span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Im linken Bild hängt ein Handtuch über dem Stuhl, im rechten Bild nicht:<br>
<img src="http://bachfeld.com/images/Figure_1.png" alt="opencv"></p>
<blockquote>
<p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p>
</blockquote>
</div>
</body>

</html>
